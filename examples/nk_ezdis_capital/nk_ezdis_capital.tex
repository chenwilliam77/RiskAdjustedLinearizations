\documentclass[12 pt, oneside]{article}
\textheight 9 in
\textwidth 6.5 in
\topmargin 0 in
\oddsidemargin .3 in
\evensidemargin .3 in
\usepackage{amssymb}
\usepackage{amsmath,amsthm}
\usepackage{amsbsy,paralist}
\usepackage{appendix}
\usepackage{natbib}
\usepackage{amsfonts}
\usepackage{graphicx}
\usepackage{epsfig}
\usepackage{color}
\usepackage{mathrsfs}
\usepackage{fancyhdr}
\usepackage{setspace}
%\usepackage[nodisplayskipstretch]{setspace}
\usepackage{fullpage}
\usepackage{cancel}
\usepackage{pgfplots}
\usepackage{lipsum}
% \usepackage{subfig}
\usepackage{wrapfig,subcaption}
\usepackage{xfrac}
\usepackage{hyperref}
\usepackage{bbm}
\let\oldemptyset\emptyset
\let\emptyset\varnothing
\newtheorem*{thm}{Theorem}
\newtheorem*{lem}{Lemma}
\newtheorem{lemma}{Lemma}[section]
\newtheorem{lemnum}{Lemma}
\newtheorem*{cor}{Corollary}
\newtheorem{corollary}{Corollary}[section]
\newtheorem{cornum}{Corollary}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{thmnum}{Theorem}
\newtheorem*{prop}{Proposition}
\newtheorem{proposition}{Proposition}[section]
\newtheorem{propnum}{Proposition}
\theoremstyle{definition}
\newtheorem*{remark}{Remarks}
\theoremstyle{definition}
\newtheorem*{eg}{Example}
\theoremstyle{definition}
\newtheorem*{defn}{Definition}
\newtheorem{definition}{Definition}
\newtheorem{defnnum}{Definition}[section]
\newcommand{\bigsum}[2]{\sum\limits_{#1}^{#2}}
\newcommand{\bigprod}[2]{\prod\limits_{#1}^{#2}}
\newcommand{\nlim}{\lim_{n\ra\infty}}
\DeclareMathOperator{\as}{a.s.}
\DeclareMathOperator{\almalw}{a.a.}
\newcommand{\vecx}{\vec{x}}
\newcommand{\vecy}{\vec{y}}
\DeclareMathOperator{\Char}{Char}
\DeclareMathOperator{\orb}{orb}
\DeclareMathOperator{\stab}{stab}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Inn}{Inn}
\DeclareMathOperator{\lcm}{lcm}
\DeclareMathOperator{\card}{card}
\DeclareMathOperator{\Cl}{Cl}
\DeclareMathOperator{\Int}{Int}
\DeclareMathOperator{\var}{Var}
\DeclareMathOperator{\cov}{Cov}
\DeclareMathOperator{\io}{i.o.}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\tr}{trace}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\vect}{vec}
\DeclareMathOperator{\diver}{div}
\DeclareMathOperator{\gradi}{grad}
\newcommand{\norm}[1]{\left\lVert#1\right\rVert}
\newcommand{\bfSigma}{\mathbf{\Sigma}}
\newcommand{\bfc}{\mathbf{c}}
\newcommand{\bfb}{\mathbf{b}}
\newcommand{\bfa}{\mathbf{a}}
\newcommand{\bfd}{\mathbf{d}}
\newcommand{\bff}{\mathbf{f}}
\newcommand{\bfh}{\mathbf{h}}
\newcommand{\bfg}{\mathbf{g}}
\newcommand{\bfi}{\mathbf{i}}
\newcommand{\bfj}{\mathbf{j}}
\newcommand{\bfk}{\mathbf{k}}
\newcommand{\bfl}{\mathbf{l}}
\newcommand{\bfm}{\mathbf{m}}
\newcommand{\bfn}{\mathbf{n}}
\newcommand{\bfo}{\mathbf{o}}
\newcommand{\bfp}{\mathbf{p}}
\newcommand{\bfq}{\mathbf{q}}
\newcommand{\bfr}{\mathbf{r}}
\newcommand{\bfs}{\mathbf{s}}
\newcommand{\bft}{\mathbf{t}}
\newcommand{\bfx}{\mathbf{x}}
\newcommand{\bfy}{\mathbf{y}}
\newcommand{\bfz}{\mathbf{z}}
\newcommand{\bfu}{\mathbf{u}}
\newcommand{\bfv}{\mathbf{v}}
\newcommand{\bfw}{\mathbf{w}}
\newcommand{\bfX}{\mathbf{X}}
\newcommand{\bfY}{\mathbf{Y}}
\newcommand{\bfA}{\mathbf{A}}
\newcommand{\bfB}{\mathbf{B}}
\newcommand{\bfC}{\mathbf{C}}
\newcommand{\bfD}{\mathbf{D}}
\newcommand{\bfE}{\mathbf{E}}
\newcommand{\bfF}{\mathbf{F}}
\newcommand{\bfG}{\mathbf{G}}
\newcommand{\bfH}{\mathbf{H}}
\newcommand{\bfI}{\mathbf{I}}
\newcommand{\bfJ}{\mathbf{J}}
\newcommand{\bfK}{\mathbf{K}}
\newcommand{\bfL}{\mathbf{L}}
\newcommand{\bfU}{\mathbf{U}}
\newcommand{\bfV}{\mathbf{V}}
\newcommand{\bfW}{\mathbf{W}}
\newcommand{\bfZ}{\mathbf{Z}}
\newcommand{\bfM}{\mathbf{M}}
\newcommand{\bfN}{\mathbf{N}}
\newcommand{\bfQ}{\mathbf{Q}}
\newcommand{\bfO}{\mathbf{O}}
\newcommand{\bfR}{\mathbf{R}}
\newcommand{\bfS}{\mathbf{S}}
\newcommand{\bfT}{\mathbf{T}}
\newcommand{\bfP}{\mathbf{P}}
\newcommand{\bfzero}{\mathbf{0}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\curA}{\mathscr{A}}
\newcommand{\curC}{\mathscr{C}}
\newcommand{\curD}{\mathscr{D}}
\newcommand{\curE}{\mathscr{E}}
\newcommand{\curH}{\mathscr{H}}
\newcommand{\curJ}{\mathscr{J}}
\newcommand{\curK}{\mathscr{K}}
\newcommand{\curN}{\mathscr{N}}
\newcommand{\curO}{\mathscr{O}}
\newcommand{\curQ}{\mathscr{Q}}
\newcommand{\curS}{\mathscr{S}}
\newcommand{\curT}{\mathscr{T}}
\newcommand{\curU}{\mathscr{U}}
\newcommand{\curV}{\mathscr{V}}
\newcommand{\curW}{\mathscr{W}}
\newcommand{\curZ}{\mathscr{Z}}
\newcommand{\curI}{\mathscr{I}}
\newcommand{\curB}{\mathscr{B}}
\newcommand{\curF}{\mathscr{F}}
\newcommand{\curG}{\mathscr{G}}
\newcommand{\curM}{\mathscr{M}}
\newcommand{\curL}{\mathscr{L}}
\newcommand{\curP}{\mathscr{P}}
\newcommand{\curR}{\mathscr{R}}
\newcommand{\curX}{\mathscr{X}}
\newcommand{\curY}{\mathscr{Y}}
\newcommand{\calA}{\mathcal{A}}
\newcommand{\calB}{\mathcal{B}}
\newcommand{\calC}{\mathcal{C}}
\newcommand{\calD}{\mathcal{D}}
\newcommand{\calE}{\mathcal{E}}
\newcommand{\calF}{\mathcal{F}}
\newcommand{\calG}{\mathcal{G}}
\newcommand{\calH}{\mathcal{H}}
\newcommand{\calI}{\mathcal{I}}
\newcommand{\calJ}{\mathcal{J}}
\newcommand{\calL}{\mathcal{L}}
\newcommand{\calK}{\mathcal{K}}
\newcommand{\calM}{\mathcal{M}}
\newcommand{\calN}{\mathcal{N}}
\newcommand{\calO}{\mathcal{O}}
\newcommand{\calP}{\mathcal{P}}
\newcommand{\calQ}{\mathcal{Q}}
\newcommand{\calR}{\mathcal{R}}
\newcommand{\calS}{\mathcal{S}}
\newcommand{\calT}{\mathcal{T}}
\newcommand{\calU}{\mathcal{U}}
\newcommand{\calV}{\mathcal{V}}
\newcommand{\calW}{\mathcal{W}}
\newcommand{\calX}{\mathcal{X}}
\newcommand{\calY}{\mathcal{Y}}
\newcommand{\calZ}{\mathcal{Z}}
\newcommand{\RA}{\Rightarrow}
\newcommand{\ra}{\rightarrow}
\newcommand{\fd}{\vspace{2.5mm}}
\newcommand{\ds}{\vspace{1mm}}
\setlength{\parindent}{24pt}
\begin{document}
These notes present a representative agent New Keynesian model with Epstein-Zin preferences and disaster shocks and borrow from Fern{\'a}ndez-Villaverde and Levintal (2018) ``Solution Methods for Models with Rare Disasters'', Kekre and Lenel (2020) ``Monetary Policy, Redistribution, and Risk Premia'', and de Groot et al. (2020) ``Valuation Risk Revalued.''

\section{Model}\label{sec:model}

\subsection{Household}

The model admits a representative agent, so I directly write households' problem as the representative agent's. The representative household chooses consumption $C_t$, labor supply $L_t$, next-period nominal  bond holdings $B_t$, and next-period capital holdings $K_t$ to maximize, in the cashless limit, the Epstein-Zin preferences
\begin{align}\label{eq:hh objective}
  V_t = \left((1 - \exp(\eta_{\beta, t})\beta)\left(C_t \calL(L_t)\right)^{1 - \psi} + \exp(\eta_{\beta, t})\beta \E_t\left[\left(V_{t + 1}\right)^{1 - \gamma}\right]^{\frac{1 - \psi}{1 - \gamma}}\right)^{\frac{1}{1 - \psi}},
\end{align}
where $\beta$ is the time preference rate; $\psi$ is the inverse intertemporal elasticity of substitution; $\gamma$ is the risk aversion coefficient; and
the labor disutility function\footnote{This functional form is proposed by Shimer (2010) (see Chapter 1.4). Kekre and Lenel (2020) adapt this functional form for Epstein-Zin preferences. I have additionally included shocks to the disutility of labor.} $\calL(L_t)$ is
\begin{align}
  \calL(L_t) = \left(1 + (\psi - 1)\exp(\eta_{l, t})\overline{\nu}\frac{L_t^{1  + \nu}}{1 + \nu}\right)^{\frac{\psi}{1 - \psi}},
\end{align}
where $\eta_{l, t}$ is a shock to labor disutility, $\overline{\nu}$ is the disutility of labor, $\nu$ is the inverse Frisch elasticity
subject to the budget constraint
\begin{align}\label{eq:hh budget constraint}
  C_t + \frac{B_t}{P_t} + Q_tK_t & \leq W_t L_t + (R_{k, t} + (1 - \delta)Q_t)\exp(\eta_{k, t}) K_{t - 1} + R_{t - 1} \frac{B_{t - 1}}{P_t} + F_t + T_t.
\end{align}
The quantity $P_t$ is the price of the final consumption good, $Q_t$ the real price of capital, $W_t$ the real wage, $R_{k, t}$ the gross real rental rate on capital, $\delta$ the rate of capital depreciation, $\eta_{k, t}$ a disaster shock,\footnote{I follow Kekre and Lenel (2020)'s specifications of the disaster shock, but I could also define an intermediate variable $\hat{K}_t$ and set $K_t = \hat{K}_t \exp(\eta_{k, t})$, following Fern{\'a}ndez-Villaverde and Levintal (2018).} $R_t$ the gross nominal interest rate on bonds, $F_t$ real profits from intermediate firms, and $T_t$ real lump-sum transfers from the government. The budget constraint (\ref{eq:hh budget constraint}) indicates that households can choose to consume, save in bonds, or invest in units of the capital stock from income through labor, capital, bonds, intermediate firms, and government transfers. Markets are assumed complete, but securities are in zero net supply. Because there is a representative agent, I may omit the Arrow securities from the budget constraint.

My notation treats $B_{t - 1}$ and $K_{t - 1}$ as the stocks of bonds and capital present at time $t$, while $B_t$ and $K_t$ are the chosen stocks of bonds and capital for the following period. I adopt this notation so that all time $t$ choices are dated at time $t$ rather than having to differentiate between the predetermined time-$t$ variables from the endogenous controls.


Solving the household's problem is the same as solving the maximization problem
\begin{align}
  \begin{split}
  &V_t = \max_{C_t, L_t, B_t, K_t} \left((1 - \exp(\eta_{\beta, t})\beta)\left(C_t \calL(L_t)\right)^{1 - \psi} + \exp(\eta_{\beta, t})\beta \E_t\left[\left(V_{t + 1}\right)^{1 - \gamma}\right]^{\frac{1 - \psi}{1 - \gamma}}\right)^{\frac{1}{1 - \psi}}\\
  & \quad + \lambda_t \left(W_t L_t + (R_{k, t} + (1 - \delta)Q_t)\exp(\eta_{k, t})K_{t - 1} + R_{t - 1} \frac{B_{t - 1}}{P_t} + F_t + T_t\right)\\
  &\quad - \lambda_t\left(C_t + \frac{B_t}{P_t} + Q_tK_t\right).
  \end{split}
\end{align}
Define $\hat{V}_t = V_t^{1 - \psi}$, and conjecture that $V_t$ is a function of the state variables $K_{t - 1}$ and $B_{t - 1}$, among other states (e.g. the realized shocks). The first-order conditions with respect to controls are
\begin{align*}
  0 & = \frac{1}{1 - \psi}\hat{V}_t^{\frac{\psi}{1 - \psi}} (1 - \exp(\eta_{\beta, t})\beta) (1 - \psi)C_t^{-\psi} \calL(L_t)^{1 - \psi} - \lambda_t\\
  0 & = \frac{1}{1 - \psi}\hat{V}_t^{\frac{\psi}{1 - \psi}}(1 - \exp(\eta_{\beta, t})\beta)(1 - \psi)C_t^{1 - \psi}\calL(L_t)^{-\psi}\frac{\partial}{\partial L}\calL(L_t) + \lambda_tW_t\\
  0 & = \frac{1}{1 - \psi}\hat{V}_t^{\frac{\psi}{1 - \psi}}\exp(\eta_{\beta, t})\beta \frac{1 - \psi}{1 - \gamma}\E_t[(V_{t + 1})^{1 - \gamma}]^{\frac{\gamma - \psi}{1 - \gamma}} (1 - \gamma)\E_t\left[V_{t + 1}^{ - \gamma}\frac{\partial V_{t + 1}}{\partial B_t}\right] - \frac{\lambda_t}{P_t},\\
  0 & = \frac{1}{1 - \psi}\hat{V}_t^{\frac{\psi}{1 - \psi}}\exp(\eta_{\beta, t})\beta \frac{1 - \psi}{1 - \gamma}\E_t[(V_{t + 1})^{1 - \gamma}]^{\frac{\gamma - \psi}{1 - \gamma}} (1 - \gamma)\E_t\left[V_{t + 1}^{ - \gamma}\frac{\partial V_{t + 1}}{\partial K_t}\right] - \lambda_t Q_t.
\end{align*}
The envelope conditions for  $B_{t - 1}$ and  $K_{t - 1}$ are
\begin{align*}
  \frac{\partial V_t}{\partial B_{t - 1}} & = \lambda_t\frac{R_{t - 1}}{P_t},\\
  \frac{\partial V_t}{\partial K_{t - 1}} & = \lambda_t(R_{k, t} + (1 - \delta)Q_t)\exp(\eta_{k, t}).
\end{align*}
The first two first-order conditions can be combined by isolating $\lambda_t$, which obtains the intratemporal consumption-labor condition
\begin{align*}
0 & = C_t^{-\psi}\calL(L_t)^{1 - \psi} + \frac{C_t^{1 - \psi}}{W_t} \calL(L_t)^{-\psi}\frac{\partial}{\partial L}\calL(L_t)\\
  & = \calL(L_t) + \frac{C_t}{W_t}\frac{\partial}{\partial L} \calL(L_t).
\end{align*}
The derivative of $\calL(L_t)$ evaluates to
\begin{align*}
  \frac{\partial}{\partial L}\calL(L_t) & = \frac{\psi}{1 - \psi}\left(1 + (\psi - 1)\exp(\eta_{l, t})\overline{\nu}\frac{L_t^{1 + \nu}}{1 + \nu}\right)^{\frac{2\psi - 1}{1 - \psi}}(\psi - 1)\exp(\eta_{l, t})\overline{\nu}L_t^\nu\\
                                        & = \frac{\psi - 1}{1 - \psi}\calL(L_t)^{\frac{2\psi - 1}{\psi}} \psi\exp(\eta_{l, t})\overline{\nu}L_t^\nu = -\calL(L_t)^{\frac{2\psi - 1}{\psi}} \psi\exp(\eta_{l, t})\overline{\nu}L_t^\nu,
\end{align*}
hence the intratemporal consumption-labor condition becomes
\begin{align*}
  0 & = 1 - \frac{C_t}{W_t}\psi \exp(\eta_{l, t})\overline{\nu}L_t^\nu\calL(L_t)^{\frac{\psi - 1}{\psi}}.
\end{align*}
Re-arrange to acquire
\begin{align}
  W_t & = \frac{\psi \exp(\eta_{l, t})\overline{\nu}C_t L_t^\nu}{\calL(L_t)^{\frac{1 - \psi}{\psi}}}.
\end{align}
Notice additionally that
\begin{align*}
  \calL(L_t)^{\frac{1 - \psi}{\psi}} = 1 + (\psi - 1)\exp(\eta_{l, t})\overline{\nu}\frac{L_t^{1 + \nu}}{1 + \nu}.
\end{align*}
The Euler equation for bonds can be obtained by combining the envelope condition for $B_{t - 1}$ with the first and third first-order conditions. Iterate the envelope condition for $B_{t - 1}$ forward by one period.
\begin{align*}
  \frac{\partial V_{t + 1}}{\partial B_t} & = \lambda_{t + 1}\frac{R_t}{P_{t + 1}}.
\end{align*}
Define
\begin{align}\label{eq:certainty equivalent definition}
\calC\calE_t = \E_t[V_{t + 1}^{1 - \gamma}]^{\frac{1}{1 - \gamma}}
\end{align}
as households' certainty equivalent. Substitute this expression and the iterated envelope condition into the third first-order condition.
\begin{align*}
  0 & = \frac{1}{1 - \psi}\hat{V}_t^{\frac{\psi}{1 - \psi}}\exp(\eta_{\beta, t})\beta(1 - \psi)\calC\calE_t^{\gamma - \psi}\E_t\left[V_{t + 1}^{-\gamma}\lambda_{t + 1}\frac{R_t}{P_{t + 1}}\right] - \frac{\lambda_t}{P_t}\\
    & = \hat{V}_t^{\frac{\psi}{1 - \psi}}\exp(\eta_{\beta, t})\beta\calC\calE_t^{\gamma - \psi}\E_t\left[V_{t + 1}^{-\gamma}\lambda_{t + 1}\frac{R_t}{P_{t + 1}}\right] - \frac{\lambda_t}{P_t}.
\end{align*}
Observe that, from the first first-order condition,
\begin{align*}
  \frac{\lambda_{t + 1}}{\lambda_t} & = \frac{\hat{V}_{t + 1}^{\frac{\psi}{1 - \psi}} (1 - \exp(\eta_{\beta, t + 1})\beta)C_{t + 1}^{-\psi}\calL(L_{t + 1})^{1 - \psi}}{\hat{V}_t^{\frac{\psi}{1 - \psi}} (1 - \exp(\eta_{\beta, t})\beta)C_t^{-\psi}\calL(L_t)^{1 - \psi}},
\end{align*}
and that $\hat{V}_t$ satisfies
\begin{align*}
  \hat{V}_t^{\frac{\psi}{1 - \psi}} & = V_t^\psi.
\end{align*}
Divide the third first-order condition by $\lambda_t/P_t$ and substitute these quantities. Re-arrange to acquire
\begin{align*}
  1 & = \exp(\eta_{\beta, t})\beta\calC\calE_t^{\gamma - \psi}\E_t\left[V_{t + 1}^{-\gamma} R_t \frac{P_t}{P_{t + 1}} V_{t + 1}^{\psi} \frac{(1 - \exp(\eta_{\beta, t + 1})\beta)C_{t + 1}^{-\psi} \calL(L_{t + 1})^{1 - \psi}}{(1 - \exp(\eta_{\beta, t})\beta)C_t^{-\psi}\calL(L_t)^{1 - \psi}} \right]\\
    & = \calC\calE_t^{\gamma - \psi}\E_t\left[\exp(\eta_{\beta, t})\beta\frac{(1 - \exp(\eta_{\beta, t + 1})\beta)C_{t + 1}^{-\psi} \calL(L_{t + 1})^{1 - \psi}}{(1 - \exp(\eta_{\beta, t})\beta)C_t^{-\psi}\calL(L_t)^{1 - \psi}}V_{t + 1}^{\psi - \gamma} R_t\frac{P_t}{P_{t + 1}}  \right].
\end{align*}
Define the gross inflation rate and real stochastic discount factors as
\begin{align}\label{eq:gross inflation rate defn}
  \Pi_t & = \frac{P_{t + 1}}{P_t},\\
  \label{eq:real sdf}
  M_{t, t + 1} & = \exp(\eta_{\beta, t})\beta \frac{1 - \exp(\eta_{\beta, t + 1})\beta}{1 - \exp(\eta_{\beta, t})\beta} \frac{C_{t + 1}^{-\psi}\calL(L_{t + 1})^{1 - \psi}}{C_t^{-\psi}\calL(L_t)^{1 - \psi}}\left(\frac{V_{t + 1}}{\calC\calE_t}\right)^{\psi - \gamma},
\end{align}
where the two time subscripts in $M_{t, t + 1}$ indicate that the real stochastic discount factor includes terms dated at times $t$ and $t + 1$.
Using these definitions, the Euler equation for bonds becomes
\begin{align}
  1 & = \E_t\left[M_{t, t + 1}\frac{R_t}{\Pi_{t + 1}}\right].
\end{align}
Households' asset pricing equation for capital can be obtained using similar steps and will take the familiar form from consumption-based asset pricing. Iterate the envelope condition for $K_{t - 1}$ forward by one period.
\begin{align*}
  \frac{\partial V_{t + 1}}{\partial K_t} = \lambda_{t + 1}(R_{K, t + 1} + (1 - \delta) Q_{t + 1})\exp(\eta_{k, t + 1}).
\end{align*}
Substitute this expression and other quantities derived previously into the fourth first-order condition.
\begin{align*}
  0 & = V_t^{\psi}\exp(\eta_{\beta, t})\beta \calC\calE_t^{\gamma - \psi}\E_t\left[V_{t + 1}^{-\gamma}\lambda_{t + 1}(R_{K, t + 1} + (1 - \delta) Q_{t + 1})\exp(\eta_{k, t + 1})\right] - \lambda_tQ_t.
\end{align*}
Divide by $\lambda_t$ and plug in $\lambda_{t + 1} / \lambda_t$.
\begin{align*}
  0 & = V_t^{\psi}\exp(\eta_{\beta, t})\beta \calC\calE_t^{\gamma - \psi}\\
    &\quad\times\E_t\left[\frac{V_{t + 1}^{\psi - \gamma} (1 - \exp(\eta_{\beta, t + 1})\beta)C_{t + 1}^{-\psi}\calL(L_{t + 1})^{1 - \psi}}{V_t^{\psi}(1 - \exp(\eta_{\beta, t})\beta)C_t^{-\psi} \calL(L_t)^{1 - \psi}}(R_{K, t + 1} + (1 - \delta) Q_{t + 1})\exp(\eta_{k, t + 1})\right] - Q_t\\
    & = \E_t\left[M_{t, t + 1}(R_{K, t + 1} + (1 - \delta)Q_{t + 1})\exp(\eta_{k, t + 1})\right] - Q_t\\
  Q_t & = \E_t\left[M_{t, t + 1}(R_{K, t + 1} + (1 - \delta)Q_{t + 1})\exp(\eta_{k, t + 1})\right].
\end{align*}
In summary, households' optimality conditions are
\begin{align}
  \label{eq:epstein zin recursion}
  V_t & = \left((1 - \exp(\eta_{\beta, t})\beta) (C_t\calL(L_t))^{1 - \psi} + \exp(\eta_{\beta, t})\beta \calC\calE_t^{1 - \psi}\right)^{\frac{1}{1 - \psi}}\\
  \calC\calE_t & = \E_t[V_{t + 1}^{1 - \gamma}]^{\frac{1}{1 - \gamma}},\\
  \label{eq:intratemporal consumption labor}
  W_t & = \frac{\psi \exp(\eta_{l, t})\overline{\nu} C_t L_t^\nu}{\calL(L_t)^{\frac{\psi - 1}{\psi}}},\\
  \label{eq:labor disutility function}
  \calL(L_t) & = \left(1 + (\psi - 1)\exp(\eta_{l, t})\overline{\nu}\frac{L_t^{1 + \nu}}{1 + \nu}\right)^{\frac{\psi}{1-\psi}},\\
  \label{eq:stochastic discount factor}
  M_{t, t + 1} & = \exp(\eta_{\beta, t})\beta\frac{1 - \exp(\eta_{\beta, t + 1})\beta}{1 - \exp(\eta_{\beta, t})\beta}\frac{C_{t + 1}^{-\psi}\calL(L_{t + 1})^{1 - \psi}}{C_t^{-\psi}\calL(L_t)^{1 - \psi}}\left(\frac{V_{t + 1}}{\calC\calE_t}\right)^{\psi - \gamma},\\
  \label{eq:euler eqn}
  1 & = \E_t\left[M_{t, t + 1}\frac{R_t}{\Pi_{t + 1}}\right],\\
  \label{eq:capital asset pricing}
  Q_t & = \E_t\left[M_{t, t + 1} \left(R_{K, t + 1} + (1 - \delta)Q_{t + 1}\right)\exp(\eta_{k, t + 1})\right].
\end{align}




\subsection{Production}

\paragraph{Final Producers}

There is a representative final goods firm which sells consumption goods in a competitive market.
It aggregates intermediate goods using the CES technology
\begin{align}
  Y_t & = \left(\int_0^1 Y_t(j)^{ \frac{\epsilon - 1}{\epsilon}}\right)^{\frac{\epsilon}{\epsilon - 1}}
\end{align}
where $\epsilon > 1$ so that inputs are substitutes. Profit maximization for the final good firm is
\begin{align}
  \max_{Y_t(j)} P_t\left(\int_0^1 Y_t(j)^{ \frac{\epsilon - 1}{\epsilon}}\right)^{\frac{\epsilon}{\epsilon - 1}} - \int_0^1 P_t(j) Y_t(j)\, dj.
\end{align}
The FOC for $Y_t(j)$ is
\begin{align*}
  0 & = P_t\frac{\epsilon}{\epsilon - 1}\left(\int_0^1 Y_t(j)^{\frac{\epsilon}{\epsilon - 1}}\right)^{\frac{1}{\epsilon - 1}}\frac{\epsilon - 1}{\epsilon} Y_t(j)^{-\frac{1}{\epsilon}} - P_t(j)\\
  0 & = \left(\int_0^1 Y_t(j)^{\frac{\epsilon}{\epsilon - 1}}\right)^{\frac{1}{\epsilon - 1}}Y_t(j)^{-\frac{1}{\epsilon}} - \frac{P_t(j)}{P_t}\\
  0 & = \left(\int_0^1 Y_t(j)^{\frac{\epsilon}{\epsilon - 1}}\right)^{-\frac{\epsilon}{\epsilon - 1}}Y_t(j) - \left(\frac{P_t(j)}{P_t}\right)^{-\epsilon}.
\end{align*}
Re-arranging obtains
\begin{align}
    Y_t(j) & =  \left(\frac{P_t(j)}{P_t}\right)^{-\epsilon} Y_t.
\end{align}
Plugging this quantity into the identity
\begin{align*}
  P_tY_t & = \int_0^1 P_t(j) Y_t(j)\, dj
\end{align*}
and simplifying yields the price index
\begin{align}
  P_t & = \left(\int_0^1 P_t(j)^{1 - \epsilon}\, dj\right)^{\frac{1}{1 - \epsilon}}.
\end{align}

\paragraph{Intermediate Producers}

Intermediate goods are producing according to the Cobb-Douglas technology
\begin{align}\label{eq:intermediate goods production function}
  Y_t(j) =  \hat{K}_t^\alpha(j)(\exp(\eta_{a, t})L_t)^{1 - \alpha}(j) - \kappa_y\exp(\eta_{A, t}),
\end{align}
where $\hat{K}_t = \exp(\eta_{k, t})K_{t - 1}$ and productivity $\exp(\eta{a, t})$ follows the unit root process
\begin{align}\label{eq:productivity process}
  \eta_{a, t} & = \mu_a + \eta_{a, t - 1} + \sigma_a \varepsilon_{a, t} + \kappa_a\eta_{k, t}.
\end{align}
Intermediate producers minimize cost subject to the constraint of meeting demand and Calvo price rigidities. Formally,
\begin{align}
  \begin{split}
    & \quad\quad\min_{\hat{K}_t(j), L_t(j)} R_{k, t} \hat{K}_t(j) + W_t L_t(j)\\
    &\text{s.t.}\quad  \hat{K}_t^\alpha(j) (\exp(\eta_{a, t})L_t)^{1 - \alpha}(j) - \kappa_y\exp(\eta_{a, t}) \geq \left(\frac{P_t(j)}{P_t}\right)^{-\epsilon}Y_t.
  \end{split}
\end{align}
The RHS of the inequality constraint is the demand from final goods producers for intermediate $j$. The Lagrangian is
\begin{align*}
  \calH & = R_{k, t} \hat{K}_t(j) + W_t L_t(j)\\
        &\quad +  MC_t(j)\left(\left(\frac{P_t(j)}{P_t}\right)^{-\epsilon}Y_t - \hat{K}_t^\alpha(j) (\exp(\eta_{a, t})L_t)^{1 - \alpha}(j) + \kappa_y\exp(\eta_{a, t})\right),
\end{align*}
so the first-order conditions are
\begin{align*}
  0 & = R_{k, t} - MC_t(j) \alpha \exp(\eta_{a, t})^{1 - \alpha} \left(\frac{L_t(j)}{\hat{K}_t(j)}\right)^{1 - \alpha}\\
  0 & = W_t - MC_t(j) (1-\alpha) \exp(\eta_{a, t})^{1 - \alpha}  \left(\frac{\hat{K}_t(j)}{L_t(j)}\right)^{\alpha},
\end{align*}
hence the optimal capital-labor ratio satisfies
\begin{align*}
  \frac{R_{k, t}}{\alpha \exp(\eta_{a, t})^{1 - \alpha}(\hat{K}_t(j)/L_t(j))^{\alpha - 1}} & = \frac{W_t}{(1-\alpha) \exp(\eta_{a, t})^{1 - \alpha}(\hat{K}_t(j)/L_t(j))^{ \alpha}}\\
  \frac{\hat{K}_t(j)}{L_t(j)} & =\frac{\alpha}{1 - \alpha} \frac{W_t}{R_{k, t}}.
\end{align*}
Since the RHS does not vary with $j$, all firms choose the same capital-labor ratio. Given this optimal ratio, the marginal cost satisfies
\begin{align*}
  MC_t & = \frac{R_{k, t}}{\alpha \exp(\eta_{a, t})^{1 - \alpha}}\left(\frac{\hat{K}_t}{L_t}\right)^{1 - \alpha}\\
       & =  \frac{R_{k, t}}{\alpha \exp(\eta_{a, t})^{1 - \alpha}}\left(\frac{\alpha}{1 - \alpha} \frac{W_t}{R_{k, t}}\right)^{1 - \alpha}\\
       & =  \left(\frac{1}{1 - \alpha}\right)^{1 - \alpha}\left(\frac{1}{\alpha}\right)^{\alpha}\frac{W_t^{1 - \alpha}R_{k, t}^{\alpha}}{ \exp(\eta_{a, t})^{1 - \alpha}}.
\end{align*}
It follows that
\begin{align*}
  R_{k, t}\hat{K}_t + W_tL_t & = \left(\frac{R_{k, t}}{\exp(\eta_{a, t})}\left(\frac{\hat{K}_t}{L_t}\right)^{1 - \alpha} + \frac{W_t}{\exp(\eta_{a, t})}\left(\frac{L_t}{\hat{K}_t}\right)^{\alpha}\right)(\exp(\eta_{a, t})\hat{K}_t^\alpha L_t^{1 - \alpha})\\
                       & = \left(\alpha MC_t + (1 - \alpha)MC_t\right)Y_t(j) = MC_t Y_t(j).
\end{align*}
Therefore, (real) profits for an intermediate producer become
\begin{align}
  F_t(j) = \frac{P_t(j)}{P_t}Y_t(j) - MC_t Y_t(j) - \kappa_y \exp(\eta_{a, t}).
\end{align}
In addition to the capital-labor choice, firms also have the chance to reset prices in every period with probability $1 - \theta$. This problem can be
written as
\begin{align}
  \begin{split}
  &\max_{P_t(j)} \E_t\sum_{s = 0}^\infty(\beta \theta)^s\frac{\exp(\eta_{\beta, t + s})}{\exp(\eta_{\beta, t})}\frac{u'(C_{t + s})}{u'(C_t)}\\
&\quad \times\left(\frac{P_t(j)}{P_{t + s}}\left(\frac{P_t(j)}{P_{t + s}}\right)^{-\epsilon}Y_{t + s} - mc_{t + s}\left(\frac{P_t(j)}{P_{t + s}}\right)^{-\epsilon}Y_{t + s} - \kappa_y\exp(\eta_{a, t})\right),
  \end{split}
\end{align}
where I have imposed that intermediate output equals demand. The first-order condition is
\begin{align*}
0 & =  (1 - \epsilon)P_t(j)^{-\epsilon}\E_t\sum_{s = 0}^\infty (\beta\theta)^s \frac{\exp(\eta_{\beta, t + s})}{\exp(\eta_{\beta, t})}\frac{u'(C_{t + s})}{u'(C_t)}(P_{t + s})^{-(1 - \epsilon)}Y_{t + s}\\
  &\quad + \epsilon P_t(j)^{-\epsilon - 1}\E_t\sum_{s = 0}^\infty (\beta\theta)^s \frac{\exp(\eta_{\beta, t + s})}{\exp(\eta_{\beta, t})}\frac{u'(C_{t + s})}{u'(C_t)} mc_{t + s}P_{t + s}^{\epsilon}Y_{t + s}
\end{align*}
Divide by $P_t(j)^{-\epsilon} / (\exp(\eta_{\beta, t})u'(C_t))$, apply the abuse of notation that $\prod_{u = 1}^0 \Pi_{t + u} = 1$, and re-arrange to obtain
\begin{align*}
  P_t(j) & = \frac{\epsilon}{\epsilon - 1}\frac{\E_t\sum_{s = 0}^\infty (\beta\theta)^s \exp(\eta_{\beta, t + s})u'(C_{t + s}) mc_{t + s}P_{t + s}^{\epsilon}Y_{t + s}}{\E_t\sum_{s = 0}^\infty (\beta\theta)^s \exp(\eta_{\beta, t + s})u'(C_{t + s})P_{t + s}^{\epsilon - 1}Y_{t + s}}\\
         & = \frac{\epsilon}{\epsilon - 1}\frac{\E_t\sum_{s = 0}^\infty (\beta\theta)^s \exp(\eta_{\beta, t + s})u'(C_{t + s}) mc_{t + s}P_t^\epsilon\left(\prod_{u = 1}^s\Pi_{t + u}\right)^{\epsilon}Y_{t + s}}{\E_t\sum_{s = 0}^\infty (\beta\theta)^s \exp(\eta_{\beta, t + s})u'(C_{t + s})P_t^{\epsilon - 1}\left(\prod_{u = 1}^s\Pi_{t + u}\right)^{\epsilon - 1}Y_{t + s}}\\
  \frac{P_t(j)}{P_t} & = \frac{\epsilon}{\epsilon - 1}\frac{\E_t\sum_{s = 0}^\infty (\beta\theta)^s \exp(\eta_{\beta, t + s})u'(C_{t + s}) mc_{t + s}\left(\prod_{u = 1}^s\Pi_{t + u}\right)^{\epsilon}Y_{t + s}}{\E_t\sum_{s = 0}^\infty (\beta\theta)^s \exp(\eta_{\beta, t + s})u'(C_{t + s})\left(\prod_{u = 1}^s\Pi_{t + u}\right)^{\epsilon - 1}Y_{t + s}}.
\end{align*}
This expression gives the optimal (real) reset price $P_t^* \equiv P_t(j) / P_t $ (note that the RHS does not depend on $j$).
Define
\begin{align}
  \overline{S}_{1, t} & = \E_t\sum_{s = 0}^\infty  (\beta\theta)^s \exp(\eta_{\beta, t + s})u'(C_{t + s}) mc_{t + s}Y_{t + s}\left( \prod_{u = 1}^s\Pi_{t + s}\right)^{\epsilon},\\
  \overline{S}_{2, t}  & = \E_t\sum_{s = 0}^\infty (\beta\theta)^s \exp(\eta_{\beta, t + s})u'(C_{t + s})Y_{t + s}\left(\prod_{u = 1}^s\Pi_{t + s}\right)^{\epsilon - 1}.
\end{align}
Using these definitions, I may write the optimal reset price more compactly as
\begin{align}
  P_t^* & = \frac{\epsilon}{\epsilon - 1}\frac{\overline{S}_{1, t}}{\overline{S}_{2, t}}
\end{align}
where $\overline{S}_{1, t}$ and $\overline{S}_{2, t}$ satisfy the recursions
\begin{align*}
  \overline{S}_{1, t} & = \exp(\eta_{\beta, t})u'(C_t) MC_t Y_t + \theta \beta \E_t\Pi_{t + s}^\epsilon \overline{S}_{1, t + 1}\\
  \overline{S}_{2, t} & = \exp(\eta_{\beta, t})u'(C_t) Y_t + \theta \beta \E_t \Pi_{t + s}^{\epsilon - 1}\overline{S}_{2, t + 1}.
\end{align*}
These recursions can be further rewritten as
\begin{align*}
  \frac{\overline{S}_{1, t}}{\exp(\eta_{\beta, t})u'(C_t)} & =  MC_t Y_t + \theta \beta \E_t\left[\frac{\exp(\eta_{\beta, t + 1}) u'(C_{t + 1})}{\exp(\eta_{\beta, t}) u'(C_t)}\Pi_{t + s}^\epsilon \frac{\overline{S}_{1, t + 1}}{\exp(\eta_{\beta, t + 1})u'(C_{t + 1})}\right]\\
  \frac{\overline{S}_{2, t}}{\exp(\eta_{\beta, t})u'(C_t)} & =  Y_t + \theta \beta \E_t\left[\frac{\exp(\eta_{\beta, t + 1}) u'(C_{t + 1})}{\exp(\eta_{\beta, t}) u'(C_t)}\Pi_{t + s}^{\epsilon - 1} \frac{\overline{S}_{2, t + 1}}{\exp(\eta_{\beta, t + 1})u'(C_{t + 1})}\right],
\end{align*}
By defining $S_{1, t} \equiv \overline{S}_{1, t}/ (\exp(\eta_{\beta, t})u'(C_t))$ and $S_{2, t} \equiv \overline{S}_{2, t}/ (\exp(\eta_{\beta, t})u'(C_t))$, I can simplify these recursions into the form I use for the numerical solution.\\

From this section, we obtain the following five equilibrium conditions:
\begin{align}
  \label{eq:mc soln}
  MC_t & =  \left(\frac{1}{1 - \alpha}\right)^{1 - \alpha}\left(\frac{1}{\alpha}\right)^{\alpha}\frac{W_t^{1 - \alpha}R_{k, t}^{\alpha}}{ \exp(\eta_{a, t})^{1 - \alpha}},\\
  \label{eq:optimal capital labor ratio}
  \frac{\exp(\eta_{k, t})K_{t - 1}}{L_t} & =\frac{\alpha}{1 - \alpha} \frac{W_t}{R_{k, t}},\\
  \label{eq:real optimal reset price}
  P_t^* & = \frac{\epsilon}{\epsilon - 1}\frac{S_{1, t}}{S_{2, t}},\\
  \label{eq:numerator recursion}
  S_{1, t} & = MC_t Y_t + \theta\E_t[M_{t, t + 1} \Pi_{t + 1}^\epsilon S_{1, t + 1}],\\
  \label{eq:denominator recursion}
  S_{2, t} & =  Y_t + \theta\E_t[M_{t, t + 1} \Pi_{t + 1}^{\epsilon - 1} S_{2, t + 1}].
\end{align}

\paragraph{Capital Producers}
For expositional clarity, I model capital production as its own sector.\footnote{I could subsume capital production within the household problem by adding as an additional constraint $K_t = \Phi(X_t/\hat{K}_t)\hat{K}_t$.}
After intermediate firms finish using the time $t$ stock of capital $\hat{K}_t = \exp(\eta_{k, t})K_{t - 1}$,  households sell their capital holdings to capital producers, who solve the problem
\begin{align}
  \max_{X_t} \left(\Phi\left(\frac{X_t}{\hat{K}_t}\right) - 1\right)Q_t\hat{K}_t - X_t.
\end{align}
In other words, capital producers maximize the static profits from producing new capital since it costs them $Q_t\hat{K}_t$ to purchase $\hat{K}_t$ units of capital and $X_t$ in investment to produce $\Phi(X_t / \hat{K}_t)Q_t \hat{K}_t$ in revenue.
The solution to this problem yields the Tobin's Q equation
\begin{align}\label{eq:tobins q}
  1 & = \Phi'\left(\frac{X_t}{\exp(\eta_{k, t})K_{t - 1}}\right) Q_t.
\end{align}
After households purchase capital back from capital producers, a fraction of the capital depreciates. Thus, the evolution of the aggregate capital stock is
\begin{align}
    \label{eq:capital accumulation equation}
  K_t & = \left(1 - \delta + \Phi\left(\frac{X_t}{\exp(\eta_{k, t})K_{t - 1}}\right)\right)\exp(\eta_{k, t})K_{t - 1},
\end{align}
where $\delta$ is the rate of depreciation and $\Phi(\cdot)$ is an investment technology satisfying standard conditions.\footnote{$\Phi'(\cdot) > 0$, $\Phi''(\cdot) < 0$, $\Phi(X_{ss}/K_{ss}) = \delta$, where $X_{ss} / K_{ss}$ is the steady state investment rate.}


\subsection{Monetary Policy}
I specify the monetary policy rule as the following Taylor rule
\begin{align}\label{eq:taylor rule}
  \frac{R_t}{R} & =  \left(\frac{R_{t - 1}}{R}\right)^{\phi_r}\left(\left(\frac{\Pi_t}{\Pi}\right)^{\phi_\pi}\left(\frac{Y_t}{Y_{t - 1}}\exp(-\mu_a)\right)^{\phi_y}\right)^{1 - \phi_r}\exp(\eta_{r, t})
\end{align}
Any proceeds from monetary policy are distributed as lump sum to the representative household.

\subsection{Aggregation}
The price level is currently characterized as the integral
\begin{align*}
  P_t^{1 - \epsilon} = \int_0^1 P_t(j)^{1 - \epsilon}\, dj.
\end{align*}
To represent the model entirely in terms of aggregates, notice that, without loss of generality, we may re-order the fraction $\theta$ of firms which cannot reset prices to the top of the interval so that
\begin{align*}
  P_t^{1 - \epsilon} = (1 - \theta)(P_t^*)^{1 - \epsilon} +  \int_{1 - \theta}^1 P_{t - 1}(j)^{1 - \epsilon}\, dj.
\end{align*}
The latter term can be further simplified under the law of large numbers assumption that a positive measure of firms which cannot change their price
still comprise a representative sample of all firms, yielding
\begin{align*}
  P_t^{1 - \epsilon} = (1 - \theta)(P_t^*)^{1 - \epsilon} +  \theta\int_0^1 P_{t - 1}(j)^{1 - \epsilon}\, dj = (1 - \theta)(P_t^*)^{1 - \epsilon} +  \theta P_{t - 1}^{1 - \epsilon}.
\end{align*}
Dividing by $P_{t - 1}^{1 - \epsilon}$ implies
\begin{align}\label{eq:inflation from optimal reset price}
  \Pi_t^{ 1 - \epsilon} & = (1 - \theta) (P_t^*\Pi_t)^{1 - \epsilon} + \theta.
\end{align}
The price dispersion term can similarly be re-written in terms of aggregates by distinguishing which firms get to change prices.
\begin{align*}
  V_t^p & = \int_0^{1 - \theta}\left(P_t^*\right)^{ - \epsilon}\, dj + \int_{1 - \theta}^1 \left(\frac{P_{t - 1}(j)}{P_t}\right)^{ - \epsilon}\, dj\\
      & = \int_0^{1 - \theta}\left(P_t^*\Pi_t\right)^{ - \epsilon}\left(\frac{1}{\Pi_t}\right)^{ - \epsilon}\, dj + \int_{1 - \theta}^1 \left(\frac{P_{t - 1}(j)}{P_{t - 1}}\right)^{ - \epsilon}\left(\frac{P_{t - 1}}{P_t}\right)^{ - \epsilon}\, dj\\
      & = (1 - \theta) (P_t^*\Pi_t)^{-\epsilon} \Pi_t^{\epsilon}  + \Pi_t^{\epsilon} \int_{1 - \theta}^1 \left(\frac{P_{t - 1}(j)}{P_{t - 1}}\right)^{ - \epsilon}\,dj.
\end{align*}
By invoking the law of large assumptions applied to any positive measure subset of firms, we must have
\begin{align*}
  \int_{1 - \theta}^1 \left(\frac{P_{t - 1}(j)}{P_{t - 1}}\right)^{ - \epsilon}\,dj & = \theta\int_0^1 \left(\frac{P_{t - 1}(j)}{P_{t - 1}}\right)^{ - \epsilon}\,dj = \theta V_{t - 1}^p.
\end{align*}
Thus, we acquire
\begin{align}\label{eq:price dispersion evol}
  V_t^p & = \Pi_t^{\epsilon}((1 - \theta) (P_t^* \Pi_t)^{-\epsilon} + \theta V_{t - 1}^p)
\end{align}


\subsection{Equilibrium}
To close the model, I need to specify the functional form for investment, remaining aggregate shocks, and market-clearing conditions.\\

\subsubsection{Investment Function}
Following Jermann (1998), I assume the investment function takes the concave form
\begin{align}\label{eq:invst fnct}
  \Phi\left(\frac{X_t}{\hat{K}_t}\right) = \frac{\overline{X}^{1/\chi}}{1 - 1/\chi}\left(\frac{X_t}{\hat{K}_t}\right)^{1 - 1/\chi} - \frac{\overline{X}}{\chi(\chi - 1)}
\end{align}
where $\overline{X} = \delta \chi / (\chi + 1)$ is the steady-state investment rate (per unit of capital). The first derivative of $\Phi(\cdot)$ w.r.t. $X_t / \hat{K}_t$ is
\begin{align}\label{eq:invst fnct first deriv}
    \Phi'\left(\frac{X_t}{\hat{K}_t}\right) & = \overline{X}^{1/\chi}\left(\frac{X_t}{ \hat{K}_t}\right)^{-1/\chi}.
\end{align}
This functional form implies the law of motion
\begin{align*}
  K_t & = \left(1 - \delta + \frac{\overline{X}^{1/\chi}}{1 - 1/\chi}\left(\frac{X_t}{\hat{K}_t}\right)^{1 - 1/\chi} - \frac{\overline{X}}{\chi(\chi - 1)}\right)\hat{K}_t\\
      & = \left(1 + \frac{\overline{X}^{1/\chi}}{1 - 1/\chi}\left(\frac{X_t}{\hat{K}_t}\right)^{1 - 1/\chi} -\delta \left(1 +  \frac{1}{(\chi - 1)(\chi + 1)}\right)\right)\hat{K}_t\\
      & = \left(1 + \frac{\overline{X}^{1/\chi}}{1 - 1/\chi}\left(\frac{X_t}{\hat{K}_t}\right)^{1 - 1/\chi} -\delta \left(\frac{\chi^2}{(\chi - 1)(\chi + 1)}\right)\right)\hat{K}_t\\
      & = \left(1 + \frac{\overline{X}^{1/\chi}}{1 - 1/\chi}\left(\frac{X_t}{\hat{K}_t}\right)^{1 - 1/\chi} -\frac{\delta\chi^2}{\chi^2(1 - 1 / \chi)(1 + 1 / \chi)}\right)\hat{K}_t\\
      & = \left(1 + \frac{\overline{X}^{1/\chi}}{1 - 1/\chi}\left(\frac{X_t}{\hat{K}_t}\right)^{1 - 1/\chi} -\frac{\overline{X}}{1 - 1 / \chi}\right)\hat{K}_t.
\end{align*}
If $K_t = \hat{K}_t = K_{ss}$ and $X_{ss} / K_{ss} = \overline{X}$, then
\begin{align*}
  1 + \frac{\overline{X}^{1 / \chi}}{1 - 1 / \chi}\overline{X}^{1 - 1 / \chi} - \frac{\overline{X}}{1 - 1 / \chi} =   1 + \frac{\overline{X}}{1 - 1 / \chi} - \frac{\overline{X}}{1 - 1 / \chi} = 1,
\end{align*}
thus verifying the original conjecture that $\overline{X}$ represents the steady-state investment rate.


\subsubsection{Exogenous Shocks}\label{sec:exog shocks}
There are five shocks in the model: $\eta_{a, t}$, $\eta_{k, t}$, $\eta_{\beta, t}$, $\eta_{l, t}$, and $\eta_{r, t}$. The first shock has been specified as an AR(1) with a disaster component. I specify $\eta_{k, t}$ below. Without loss of generality, I assume the last three shocks follow AR(1) processes with persistence $\rho_i$ and standard deviation $\sigma_i$.

There are multiple ways to model the disaster shock. The simplest approach is the approach taken by Kekre and Lenel (2020). The shock $\eta_{k, t}$ equals $\underline{\eta}_k < 0$ with probability $p_t$ and zero with probability $1 - p_t$. The probability of a disaster varies according to a two-state Markov process, which takes values $\underline{p}$ and $\overline{p}$, with $\underline{p} < \overline{p}$. The transition probability away from $\underline{p}$ ($\overline{p}$) toward $\overline{p}$ ($\underline{p}$) is $\overline{\rho}_p$ ($\underline{\rho}_p$). The values and transition probabilities of the Markov chain are restricted by the requirement that the unconditional mean of the Markov chain must be $p$, i.e.
\begin{align*}
  \frac{\underline{\rho}_p\underline{p} + \overline{\rho}_p \overline{p}}{\underline{\rho}_p + \overline{\rho}_p} = p.
\end{align*}
In this case, I construct martingale difference sequences for $\eta_{k, t}$ and $p_t$ by defining $\varepsilon_{k, t} = \eta_{k, t} - \E_{t - 1}[\eta_{k, t}]$ and $\varepsilon_{p, t} = p_t - \E_{t- 1}[p_t]$. Then
\begin{align}
  \eta_{k, t + 1} & = \underline{\eta}_k p_t + \varepsilon_{k, t + 1},\\
  \eta_{p, t + 1} & = \begin{cases}
    \underline{\rho}_p \underline{p} + (1 - \underline{\rho}_p) \overline{p} & \text{if } p_t = \underline{p}\\
    \overline{\rho}_p \overline{p} + (1 - \overline{\rho}_p) \underline{p} & \text{if } p_t = \overline{p}
  \end{cases} + \varepsilon_{p, t + 1}.
\end{align}

The second approach models the time variation in $p_t$ as a discrete-time Cox-Ingersoll-Ross process:
\begin{align}
  p_{t + 1} & = (1 - \rho_p) p + \rho_p p_t + \sqrt{p_t}\sigma_p \varepsilon_{p, t + 1}.
\end{align}
In this case, $\varepsilon_{p, t + 1} \sim N(0, 1)$. The disaster shock $\eta_{k, t}$ still follows the martingale difference sequence $\tilde{\eta}_{k, t}$. The disadvantage of this approach is that $p_{t + 1}$ can move outside $[0, 1]$, given a sufficiently large shock.

The third approach models the time variation in $p_t$ in logs to avoid $p_t$ moving below zero:
\begin{align}
  \log(p_{t + 1}) & = (1 - \rho_p) \log(p) + \rho_p \log(p_t) + \sigma_p \varepsilon_{p, t + 1}.
\end{align}
This approach still risks $p_t$ increasing above 1.

The fourth approach models the disaster shock as an exponentially distributed shock $\eta_{k, t} \sim \text{Exponential}(p_t)$, where $p_t$ is now the intensity of the exponential distribution. The evolution of $p_t$ can be modeled in three ways, as before, but $p_t$ may now increase above one.

The fifth approach uses time variation in the size of the shock rather than the probability. The disaster shock $\eta_{k, t}$ takes the form
\begin{align}
  \eta_{k, t} = \hat{\eta}_{k, t} p_t,
\end{align}
where $\tilde{\eta}_{k, t}$ is modeled as either a Bernoulli or an Exponential random variable and $p_t$ evolves either according to the Cox-Ingersoll-Ross process or in logs.

\subsubsection{Market Clearing}
Markets must clear for capital, labor, bonds, final goods, and intermediate goods. The first three markets clear as a consequence of optimality conditions and the assumption that bonds have zero net supply. To clear the market for final goods, we set the sum of aggregate consumption demand $C_t$ and investment demand $X_t$ equal to aggregate supply $Y_t$ net of fixed costs, which satisfies
\begin{align*}
\int_0^1( \hat{K}_t^\alpha (L_t\exp(\eta_{a, t}))^{1 - \alpha} - \kappa_y \exp(\eta_{a, t}))\, dj & = \int_0^1\left(\frac{P_t(j)}{P_t}\right)^{-\epsilon} Y_t\, dj\\
  \hat{K}_t^\alpha (\exp(\eta_{a, t})L_t)^{1 - \alpha} - \kappa_y\exp(\eta_{a, t}) & = Y_t \int_0^1\left(\frac{P_t(j)}{P_t}\right)^{-\epsilon} \, dj = V_t^p Y_t.
\end{align*}
Re-arranging yields the output market-clearing condition
\begin{align}\label{eq:output market clearing}
  C_t + X_t & = Y_t,\\
  \label{eq:aggregate supply}
  Y_t & = \frac{(\exp(\eta_{k, t}) K_{t - 1})^{\alpha}(\exp(\eta_{a, t})L_t)^{1 - \alpha} - \kappa_y \exp(\eta_{a, t})}{V_t^p}.
\end{align}
It can be shown that $V_t^p \geq 1$ by applying Jensen's inequality. For our purposes, because the dimensionality of our model is not too large, we add the auxiliary $Y_t$ variable, even though we could substitute it out of the system of equations.


\subsubsection{Equilibrium Conditions}
All together, the full set of equilibrium conditions are
\begin{align}
  \label{eq:epstein zin recursion eqm}
  V_t & = \left((1 - \exp(\eta_{\beta, t})\beta )(C_t\calL(L_t))^{1 - \psi} + \exp(\eta_{\beta, t})\beta \calC\calE_t^{1 - \psi}\right)^{\frac{1}{1 - \psi}}\\
  \label{eq:certainty equivalent eqm}
  \calC\calE_t & = \E_t[V_{t + 1}^{1 - \gamma}]^{\frac{1}{1 - \gamma}},\\
  \label{eq:intratemporal consumption labor eqm}
  W_t & = \frac{\psi \exp(\eta_{l, t})\overline{\nu} C_t L_t^\nu}{\calL(L_t)^{\frac{\psi - 1}{\psi}}},\\
  \label{eq:labor disutility function eqm}
  \calL(L_t) & = \left(1 + (\psi - 1)\exp(\eta_{l, t})\overline{\nu}\frac{L_t^{1 + \nu}}{1 + \nu}\right)^{\frac{\psi}{1-\psi}},\\
  \label{eq:stochastic discount factor eqm}
  M_{t, t + 1} & = \exp(\eta_{\beta, t})\beta\frac{1 - \exp(\eta_{\beta, t + 1})\beta}{1 - \exp(\eta_{\beta, t})\beta}\frac{C_{t + 1}^{-\psi}\calL(L_{t + 1})^{1 - \psi}}{C_t^{-\psi}\calL(L_t)^{1 - \psi}}\left(\frac{V_{t + 1}}{\calC\calE_t}\right)^{\psi - \gamma},\\
  \label{eq:euler eqn eqm}
  1 & = \E_t\left[M_{t, t + 1}\frac{R_t}{\Pi_{t + 1}}\right],\\
  \label{eq:capital asset pricing eqm}
  Q_t & = \E_t\left[M_{t, t + 1} \left(R_{K, t + 1} + (1 - \delta)Q_{t + 1}\right)\exp(\eta_{k, t + 1})\right],\\
  \label{eq:mc soln eqm}
  MC_t & =  \left(\frac{1}{1 - \alpha}\right)^{1 - \alpha}\left(\frac{1}{\alpha}\right)^{\alpha}\frac{W_t^{1 - \alpha}R_{k, t}^{\alpha}}{ \exp(\eta_{a, t})^{1 - \alpha}},\\
  \label{eq:optimal capital labor ratio eqm}
  \frac{\exp(\eta_{k, t})K_{t - 1}}{L_t} & =\frac{\alpha}{1 - \alpha} \frac{W_t}{R_{k, t}},\\
  \label{eq:real optimal reset price eqm}
  P_t^* & = \frac{\epsilon}{\epsilon - 1}\frac{S_{1, t}}{S_{2, t}},\\
  \label{eq:numerator recursion eqm}
  S_{1, t} & = MC_t Y_t + \theta\E_t[M_{t, t + 1} \Pi_{t + 1}^\epsilon S_{1, t + 1}],\\
  \label{eq:denominator recursion eqm}
  S_{2, t} & =  Y_t + \theta\E_t[M_{t, t + 1} \Pi_{t + 1}^{\epsilon - 1} S_{2, t + 1}],\\
  \label{eq:tobins q eqm}
  1 & = \Phi'\left(\frac{X_t}{\exp(\eta_{k, t})K_{t - 1}}\right) Q_t,\\
  \label{eq:law of motion capital eqm}
  K_t & = \left(1 - \delta + \Phi\left(\frac{X_t}{\exp(\eta_{k, t})K_{t - 1}}\right)\right)\exp(\eta_{k, t})K_{t - 1},\\
  \label{eq:inflation from optimal reset price eqm}
  \Pi_t^{ 1 - \epsilon} & = (1 - \theta) (P_t^*\Pi_t)^{1 - \epsilon} + \theta,\\
  \label{eq:price dispersion evol eqm}
  V_t^p & = \Pi_t^{\epsilon}((1 - \theta) (P_t^* \Pi_t)^{-\epsilon} + \theta V_{t - 1}^p),\\
  \label{eq:taylor rule eqm}
  \frac{R_t}{R} & =  \left(\frac{R_{t - 1}}{R}\right)^{\phi_r}\left(\left(\frac{\Pi_t}{\Pi}\right)^{\phi_\pi}\left(\frac{Y_t}{Y_{t - 1}}\exp(-\mu_a)\right)^{\phi_y}\right)^{1 - \phi_r}\exp(\eta_{r, t}),\\
  \label{eq:output market clearing eqm}
  C_t + X_t & = Y_t,\\
  \label{eq:aggregate supply eqm}
  Y_t & = \frac{(\exp(\eta_{k, t}) K_{t - 1})^{\alpha}(\exp(\eta_{a, t})L_t)^{1 - \alpha} - \kappa_y \exp(\eta_{a, t})}{V_t^p},
\end{align}
the three exogenous processes
\begin{align}
  \label{eq:ar1 beta}
  \eta_{\beta, t + 1} & = \rho_\beta\eta_{\beta, t} + \sigma_\beta \varepsilon_{\beta, t + 1},\\
  \eta_{l, t + 1} & = \rho_L\eta_{l, t} + \sigma_L \varepsilon_{L, t + 1},\\
  \label{eq:ar1 R}
  \eta_{r, t + 1} & = \rho_R\eta_{r, t} + \sigma_R \varepsilon_{R, t + 1},
\end{align}
the process for productivity
\begin{align}
  \label{eq:productivity process eqm}
  \eta_{a, t} & = \mu_a + \eta_{a, t - 1} + \sigma_a \varepsilon_{a, t} + \kappa_a\eta_{k, t},
\end{align}
and one of the proposed disaster processes in Section \ref{sec:exog shocks}.

\subsubsection{Stationary Equilibrium Conditions}
Because of the unit root in $\eta_{a, t}$, the model is non-stationary. To obtain a stationary representation, define the transformations
\begin{align*}
  \tilde{C}_t & = \frac{C_t}{\exp(\eta_{a, t})}, \quad \tilde{V}_t = \frac{V_t}{\exp(\eta_{a, t})}, \quad \tilde{\calC\calE}_t = \frac{\calC\calE_t}{\exp(\eta_{a, t})}, \quad \tilde{K}_t = \frac{K_t}{\exp(\eta_{a, t})},\\
  \tilde{K}_{t - 1} & = \frac{K_{t - 1}}{\exp(\eta_{a, t})}, \quad \tilde{W}_t = \frac{W_t}{\exp(\eta_{a, t})}, \quad \tilde{X}_t = \frac{X_t}{\exp(\eta_{a, t})}, \quad \tilde{Y}_t = \frac{Y_t}{\exp(\eta_{a, t})},\\
  A_t & = \exp(\eta_{a, t} - \eta_{a, t - 1} - \mu_a) = \exp(\sigma_a\varepsilon_{a, t} + \kappa_a\eta_{k, t}).
\end{align*}
Most of the calculations for the stationary representation are straightforward, so I only show the work for the more complicated cases.

Substituting the transformations in the recursion for preferences (\ref{eq:epstein zin recursion eqm}) implies
\begin{align*}
  \exp(\eta_{a, t})\tilde{V}_t & = \left((1 - \exp(\eta_{\beta, })\beta)\beta \exp(\eta_{a, t})^{1 - \psi}(\tilde{C}_t\calL(L_t))^{1 - \psi} + \exp(\eta_{\beta, t}) \beta \exp(\eta_{a, t})^{1 - \psi}\tilde{\calC\calE}_t^{1 - \psi}\right)^{\frac{1}{1 - \psi}}\\
& = \exp(\eta_{a, t}) \left((1 - \exp(\eta_{\beta, })\beta)\beta(\tilde{C}_t\calL(L_t))^{1 - \psi} + \exp(\eta_{\beta, t})\beta \tilde{\calC\calE}_t^{1 - \psi}\right)^{\frac{1}{1 - \psi}}.
\end{align*}

The certainty equivalent definition (\ref{eq:certainty equivalent eqm}) becomes
\begin{align*}
  \exp(\eta_{a, t})\tilde{\calC\calE}_t & = \E_t[\tilde{V}_{t + 1}^{1 - \gamma} \eta_{a, t + 1}^{1 - \gamma}]^{\frac{1}{1 - \gamma}}\\
                                        & =   \E_t\left[\tilde{V}_{t + 1}^{1 - \gamma} \exp(\eta_{a, t + 1})^{1 - \gamma}\frac{\exp(\eta_{a, t})^{1 - \gamma}}{\exp(\eta_{a, t})^{1 - \gamma}}\right]^{\frac{1}{1 - \gamma}}\\                                                          & =   \exp(\eta_{a, t})\E_t\left[\tilde{V}_{t + 1}^{1 - \gamma} \left(\frac{\exp(\eta_{a, t + 1})}{\exp(\eta_{a, t})}\right)^{1 - \gamma}\right]^{\frac{1}{1 - \gamma}}\\
  \tilde{\calC\calE}_t & = \exp(\mu_a)\E_t\left[A_{t + 1}\tilde{V}_{t + 1}^{1 - \gamma}\right]^{\frac{1}{1 - \gamma}}.
\end{align*}

The stochastic discount factor (\ref{eq:stochastic discount factor eqm}) becomes
\begin{align*}
  M_{t, t + 1} & = \exp(\eta_{\beta, t})\beta \frac{1 - \exp(\eta_{\beta, t + 1})\beta}{1 - \exp(\eta_{\beta, t})\beta} \frac{\tilde{C}_{t + 1}^{ - \psi}}{\tilde{C}_t^{ - \psi}}\left(\frac{\exp(\eta_{a, t + 1})}{\exp(\eta_{a, t})}\right)^\psi \\
               &\quad\times\frac{\calL(L_{t + 1})^{1 - \psi}}{\calL(L_t)^{1 - \psi}}\left(\frac{\tilde{V}_{t + 1}}{\tilde{\calC\calE}_t}\right)^{\psi - \gamma}\left(\frac{\exp(\eta_{a, t + 1})}{\exp(\eta_{a, t})}\right)^{-(\psi - \gamma)}\\
               & = \exp(\eta_{\beta, t})\beta \frac{1 - \exp(\eta_{\beta, t + 1})\beta}{1 - \exp(\eta_{\beta, t})\beta} \frac{\tilde{C}_{t + 1}^{ - \psi}}{\tilde{C}_t^{ - \psi}}\frac{\calL(L_{t + 1})^{1 - \psi}}{\calL(L_t)^{1 - \psi}}\left(\frac{\tilde{V}_{t + 1}}{\tilde{\calC\calE}_t}\right)^{\psi - \gamma}\left(\frac{\exp(\eta_{a, t + 1})}{\exp(\eta_{a, t})}\right)^{\gamma}\\
               & = \exp(\eta_{\beta, t})\beta \frac{1 - \exp(\eta_{\beta, t + 1})\beta}{1 - \exp(\eta_{\beta, t})\beta} \frac{\tilde{C}_{t + 1}^{ - \psi}}{\tilde{C}_t^{ - \psi}}\frac{\calL(L_{t + 1})^{1 - \psi}}{\calL(L_t)^{1 - \psi}}\left(\frac{\tilde{V}_{t + 1}}{\tilde{\calC\calE}_t}\right)^{\psi - \gamma}(A_{t + 1}\exp(\mu_a))^\gamma
\end{align*}

The recursions for the optimal price resetting problem become
\begin{align*}
  \exp(\eta_{a, t})\tilde{S}_{1, t} & = MC_t\exp(\eta_{a, t})\tilde{Y}_t + \theta\E_t[M_{t, t + 1}\Pi_{t + 1}^\epsilon \tilde{S}_{1, t + 1}\exp(\eta_{a, t + 1})]\\
  \tilde{S}_{1, t} & = MC_t \tilde{Y}_t + \exp(\mu_a)\theta\E_t[M_{t, t + 1}A_{t + 1}\Pi_{t + 1}^\epsilon \tilde{S}_{1, t + 1}]\\
  \exp(\eta_{a, t})\tilde{S}_{2, t} & = \exp(\eta_{a, t})\tilde{Y}_t + \theta\E_t[M_{t, t + 1}\Pi_{t + 1}^{\epsilon - 1} \tilde{S}_{2, t + 1}\exp(\eta_{a, t + 1})]\\
\tilde{S}_{2, t} & = \tilde{Y}_t + \exp(\mu_a)\theta\E_t[M_{t, t + 1}A_{t + 1}\Pi_{t + 1}^{\epsilon - 1} \tilde{S}_{2, t + 1}].
\end{align*}


Then the stationary equilibrium conditions are
\begin{align}
  \label{eq:epstein zin recursion eqm stat}
  \tilde{V}_t & = \left((1 - \exp(\eta_{\beta, })\beta)\beta(\tilde{C}_t\calL(L_t))^{1 - \psi} + \exp(\eta_{\beta, t})\beta \tilde{\calC\calE}_t^{1 - \psi}\right)^{\frac{1}{1 - \psi}},\\
  \label{eq:certainty equivalent eqm stat}
  \tilde{\calC\calE}_t & = \exp(\mu_a)\E_t[A_{t + 1}\tilde{V}_{t + 1}^{1 - \gamma}]^{\frac{1}{1 - \gamma}},\\
  \label{eq:intratemporal consumption labor eqm stat}
  \tilde{W}_t & = \frac{\psi \exp(\eta_{l, t})\overline{\nu} \tilde{C}_t L_t^\nu}{\calL(L_t)^{\frac{\psi - 1}{\psi}}},\\
  \label{eq:labor disutility function eqm stat}
  \calL(L_t) & = \left(1 + (\psi - 1)\exp(\eta_{l, t})\overline{\nu}\frac{L_t^{1 + \nu}}{1 + \nu}\right)^{\frac{\psi}{1-\psi}},\\
  \label{eq:stochastic discount factor eqm stat}
  \begin{split}
  M_{t, t + 1} & = \exp(\eta_{\beta, t})\beta \frac{1 - \exp(\eta_{\beta, t + 1})\beta}{1 - \exp(\eta_{\beta, t})\beta} \frac{\tilde{C}_{t + 1}^{ - \psi}}{\tilde{C}_t^{ - \psi}}\frac{\calL(L_{t + 1})^{1 - \psi}}{\calL(L_t)^{1 - \psi}}\\
  &\quad\times \left(\frac{\tilde{V}_{t + 1}}{\tilde{\calC\calE}_t}\right)^{\psi - \gamma}(A_{t + 1}\exp(\mu_a))^\gamma,
  \end{split}\\
  \label{eq:euler eqn eqm stat}
  1 & = \E_t\left[M_{t, t + 1}\frac{R_t}{\Pi_{t + 1}}\right],\\
  \label{eq:capital asset pricing eqm stat}
  Q_t & = \E_t\left[M_{t, t + 1} \left(R_{K, t + 1} + (1 - \delta)Q_{t + 1}\right)\exp(\eta_{k, t + 1})\right],\\
  \label{eq:mc soln eqm stat}
  MC_t & =  \left(\frac{1}{1 - \alpha}\right)^{1 - \alpha}\left(\frac{1}{\alpha}\right)^{\alpha}\tilde{W}_t^{1 - \alpha}R_{k, t}^{\alpha},\\
  \label{eq:optimal capital labor ratio eqm stat}
  \frac{\exp(\eta_{k, t})\tilde{K}_{t - 1}}{L_t} & =\frac{\alpha}{1 - \alpha} \frac{\tilde{W}_t}{R_{k, t}},\\
  \label{eq:real optimal reset price eqm stat}
  P_t^* & = \frac{\epsilon}{\epsilon - 1}\frac{\tilde{S}_{1, t}}{\tilde{S}_{2, t}},\\
  \label{eq:numerator recursion eqm stat}
  \tilde{S}_{1, t} & = MC_t \tilde{Y}_t + \exp(\mu_a)\theta\E_t[M_{t, t + 1}A_{t + 1}\Pi_{t + 1}^\epsilon \tilde{S}_{1, t + 1}],\\
  \label{eq:denominator recursion eqm stat}
  \tilde{S}_{2, t} & = \tilde{Y}_t + \exp(\mu_a)\theta\E_t[M_{t, t + 1}A_{t + 1}\Pi_{t + 1}^{\epsilon - 1} \tilde{S}_{2, t + 1}],\\
  \label{eq:tobins q}
  1 & = \Phi'\left(\frac{\tilde{X}_t}{\exp(\eta_{k, t})\tilde{K}_{t - 1}}\right) Q_t,\\
  \label{eq:law of motion capital eqm stat}
  \tilde{K}_t & = \left(1 - \delta + \Phi\left(\frac{\tilde{X}_t}{\exp(\eta_{k, t})\tilde{K}_{t - 1}}\right)\right)\exp(\eta_{k, t})\tilde{K}_{t - 1},\\
  \label{eq:inflation from optimal reset price eqm stat}
  \Pi_t^{ 1 - \epsilon} & = (1 - \theta) (P_t^*\Pi_t)^{1 - \epsilon} + \theta,\\
  \label{eq:price dispersion evol eqm stat}
  V_t^p & = \Pi_t^{\epsilon}((1 - \theta) (P_t^* \Pi_t)^{-\epsilon} + \theta V_{t - 1}^p),\\
  \label{eq:taylor rule eqm stat}
  \frac{R_t}{R} & =  \left(\frac{R_{t - 1}}{R}\right)^{\phi_r}\left(\left(\frac{\Pi_t}{\Pi}\right)^{\phi_\pi}\left(\frac{\tilde{Y}_t}{\tilde{Y}_{t - 1}} A_t\right)^{\phi_y}\right)^{1 - \phi_r}\exp(\eta_{r, t}),\\
  \label{eq:output market clearing eqm stat}
  \tilde{C}_t + \tilde{X}_t & = \tilde{Y}_t,\\
  \label{eq:aggregate supply eqm stat}
  \tilde{Y}_t & = \frac{(\exp(\eta_{k, t}) \tilde{K}_{t - 1})^{\alpha}(L_t)^{1 - \alpha} - \kappa_y}{V_t^p},
\end{align}

\subsection{Deterministic Steady State}
To provide an initial guess for the risk-adjusted linearization and to provide a verification that the model is coded correctly, I determine some reasonable guesses for the deterministic steady state.

Within this subsection, I denote the deterministic steady state values by an absence of a time subscript. The exogenous processes, by construction, have steady states of 0, i.e. $\eta_\beta = \eta_L = \eta_A = \eta_R = 0$. Further, $A = 1$.

Focusing now on the endogenous equilibrium conditions, from (\ref{eq:intratemporal consumption labor eqm}),
\begin{align*}
  W & = \frac{\varphi L^\nu}{C^{-\gamma}}.
\end{align*}
From (\ref{eq:stochastic discount factor}),
\begin{align*}
  M = \beta.
\end{align*}
From (\ref{eq:tobins q eqm}), the fact that $\overline{X}$ is the steady-state investment rate, and the fact that $\Phi'(\overline{X}) = 1$,
\begin{align*}
  Q = 1.
\end{align*}
From (\ref{eq:capital asset pricing eqm}), first observing that,
\begin{align*}
  \Phi(\overline{X}) = \frac{\overline{X}\chi}{\chi - 1} - \frac{\overline{X}}{\chi (\chi - 1)} = \overline{X}\frac{\chi^2 - 1}{\chi(\chi - 1)} = \overline{X}\frac{(\chi - 1)(\chi + 1)}{\chi (\chi - 1)} = \frac{\delta\chi}{\chi + 1}\frac{\chi + 1}{\chi} = \delta,
\end{align*}
which ensures that $K$ does indeed remain at steady state, it must be the cast that
\begin{align*}
  1 & = \beta(R_K + (1 - \delta + \Phi(\overline{X}) - \overline{X})\\
  R_K & = \frac{1}{\beta} + \overline{X} - 1.
\end{align*}
Equation (\ref{eq:mc soln eqm}) remains as it is but with time subscripts removed. From (\ref{eq:numerator recursion eqm}),
\begin{align*}
  \tilde{S}_1 & = MC \cdot Y + \theta \beta \Pi^\epsilon \tilde{S}_1 \Rightarrow \tilde{S}_1 = \frac{MC\cdot Y}{1 - \theta\beta \Pi^\epsilon}.
\end{align*}
From (\ref{eq:denominator recursion eqm}),
\begin{align*}
  \tilde{S}_2 & = Y + \theta\beta \Pi^{\epsilon - 1}\tilde{S}_2 \Rightarrow \tilde{S}_1 = \frac{Y}{1 - \theta\beta \Pi^{\epsilon - 1}}.
\end{align*}
Thus,
\begin{align*}
  P^* & = \frac{\epsilon}{\epsilon - 1}MC \frac{1 - \theta \Pi^{\epsilon - 1}}{1 - \theta \Pi^{\epsilon}}.
\end{align*}
From (\ref{eq:inflation from optimal reset price eqm}),
\begin{align*}
  \Pi^{1 - \epsilon} & = ( 1- \theta) \left(P^* \Pi\right)^{1 - \epsilon} + \theta
\end{align*}
Note that $P^*$ depends on $MC$ and fundamental parameters, hence the above equation pins down $MC$, which then pins down the ratio of $K$ to $L$.
From (\ref{eq:price dispersion evol eqm}),
\begin{align*}
  V^p & = \Pi^\epsilon\left((1 - \theta)(P^* \Pi)^{-\epsilon} + \theta V^p\right)\\
  V^p & = \frac{(1 - \theta)(P^* \Pi)^{-\epsilon}}{\Pi^{-\epsilon} - \theta} = \frac{(1- \theta)(P^*)^{-\epsilon}}{1 - \theta \Pi^{\epsilon}}.
\end{align*}
From the Taylor rule (\ref{eq:taylor rule eqm}), the steady state interest and inflation rates are $R$ and $\Pi$, respectively, and from the Euler equation (\ref{eq:euler eqn eqm}), $R$ must satisfy
\begin{align*}
  R = \frac{\Pi}{\beta}.
\end{align*}
From (\ref{eq:output market clearing eqm}),
\begin{align*}
  C + X = Y.
\end{align*}
From (\ref{eq:aggregate supply eqm}),
\begin{align*}
  Y & = \frac{K^\alpha L^{1 - \alpha}}{V^p}.
\end{align*}
As shown previously, the steady-state investment rate is $\overline{X}$, hence
\begin{align*}
  X = \overline{X}K
\end{align*}
Finally, I claim that the deterministic steady state reduces to a nonlinear equation in $L$. Using the aggregate supply and capital accumulation equations,
\begin{align*}
  C + \overline{X} K = \frac{K^\alpha L^{1 - \alpha}}{V^p}.
\end{align*}
The optimal capital-labor ratio implies
\begin{align*}
  K & = \frac{\alpha}{1 - \alpha}\frac{W}{R_K}L,\\
  C + \overline{X} K & = \left(\frac{\alpha}{1 - \alpha}\right)^{\alpha} \left(\frac{W}{R_K}\right)^\alpha\frac{L}{V^p}.
\end{align*}
The intratemporal condition for consumption and labor implies
\begin{align*}
  K & = \frac{\alpha}{1 - \alpha}\frac{\varphi L^\nu}{C^{-\gamma} R_K} L,\\
  C + \delta K & = \left(\frac{\alpha}{1 - \alpha}\right)^{\alpha} \left(\frac{\varphi L^\nu}{C^{-\gamma}R_K }\right)^\alpha\frac{L}{V^p}.
\end{align*}
Given a guess for $L$, I can compute $C$ using these two equations. Given $C$, I can compute $W$. Given the wage $W$, I can compute $K$ and $MC$. Given the marginal cost $MC$, I can compute the inflation-related terms.




\section{Risk-Adjusted Linearization}\label{sec:ral}

We now proceed to converting the equilibrium conditions into a suitable form for a risk-adjusted linearization. The system should conform to the representation
\begin{align*}
  0 & = \log \E_t\left[\exp\left(\xi(z_t, y_t) + \Gamma_5 z_{t + 1} + \Gamma_6 y_{t + 1}\right)\right]\\
  z_{t + 1} & = \mu(z_t, y_t) + \Lambda(z_t, y_t) (y_{t + 1} - \E_t y_{t + 1}) + \Sigma(z_t, y_t) \varepsilon_{t + 1},
\end{align*}
where $z_t$ are (predetermined) state variables and $y_t$ are (nondetermined) jump variables.

For the remainder of this section, lower case variables are the logs of previously upper case variables, and with a small abuse of notation, let $s_{1, t} = \log(S_{1, t})$ and $s_{2, t} = \log(S_{2, t})$. Additionally, let $r_{k, t} = \log(R_{K, t})$ and $v_t = \log(V_t^p)$.

\fd

Equation (\ref{eq:intratemporal consumption labor eqm}) becomes
\begin{align*}
  1 & = \varphi \exp(\eta_{l, t})\frac{L_t^\nu}{C_t^{-\gamma}W_t}\\
  0 & = \log \E_t\left[\exp\left(\underbrace{\log(\varphi) + \eta_{l, t} + \nu l_t - (- \gamma c_t + w_t)}_{\xi}\right)\right].
\end{align*}

Equation (\ref{eq:stochastic discount factor}) will not be used in the system of equations for the risk-adjusted linearization,
but it simplifies the other equations. Taking logs and re-arranging yields
\begin{align*}
  0 & =  \log(\beta) + \eta_{\beta, t + 1} + (-\gamma c_{t + 1}) - \eta_{\beta, t} - (-\gamma c_t) - m_{t + 1}\\
  m_{t + 1}  & = \underbrace{\log(\beta) -\eta_{\beta, t} + \gamma c_t}_{\xi} + \underbrace{\eta_{\beta, t + 1} - \gamma c_{t + 1}}_{\text{forward-looking}}.
\end{align*}

Equation (\ref{eq:euler eqn eqm}) becomes
\begin{align*}
  0 & = \log\E_t\left[\exp\left(\underbrace{r_t}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} - \underbrace{\pi_{t + 1}}_{\text{forward-looking}}  \right)\right].
\end{align*}

Equation (\ref{eq:tobins q eqm}) becomes
\begin{align*}
  0 & = \log\E_t\left[\exp\left(q_t + \log\left(\Phi'\left(\exp(x_t - k_{t - 1})\right)\right)\right)\right].
\end{align*}

For equation (\ref{eq:capital asset pricing eqm}), observe that the RHS is not log-linear in the forward-looking variables. To handle this case, I define the new variable
\begin{align}\label{eq:Omega defn}
  \Omega_t & = R_{K, t} + Q_t\left(1 - \delta + \Phi\left(\frac{X_t}{K_{t - 1}}\right) - \Phi'\left(\frac{X_t}{K_{t - 1}}\right)\frac{X_t}{K_{t - 1}}\right).
\end{align}
Then (\ref{eq:capital asset pricing eqm}) can be written as
\begin{align*}
  1 & = \E_t\left[\frac{M_{t, t + 1} \Omega_{t + 1}}{Q_t}\right]\\
  0 & = \log\E_t\left[\exp(m_{t + 1} + \omega_{t + 1} - q_t)\right].
\end{align*}

Equation (\ref{eq:mc soln eqm}) becomes
\begin{align*}
  0 & = \log\E_t\left[\exp\left(\underbrace{(1 - \alpha)w_t + \alpha r_{k, t} - a_t -(1 - \alpha)\log(1 - \alpha) - \alpha \log(\alpha) - mc_t}_{\xi} \right)\right].
\end{align*}

Equation (\ref{eq:optimal capital labor ratio eqm}) becomes
\begin{align*}
  0 & = \log\E_t\left[\exp\left(\underbrace{k_{t - 1} - l_t - \log\left(\frac{\alpha}{1 - \alpha}\right) - (w_t - r_{k, t})}_{\xi} \right)\right].
\end{align*}

Like the stochastic discount factor, equation (\ref{eq:real optimal reset price eqm}) will not be used in the system of equations, but it will be useful to simplify other equations. Taking logs yields
\begin{align*}
  p_t^* & = \log\left(\frac{\epsilon}{\epsilon - 1}\right) + s_{1, t} - s_{2, t}.
\end{align*}

Equation (\ref{eq:numerator recursion eqm}) becomes
\begin{align*}
  & S_{1, t} - MC_t Y_t\\
   & = \E_t\left[\exp\left(\log(\theta) + m_{t + 1} + \epsilon \pi_{t + 1} + s_{1, t + 1}\right)\right]\\
  0 & = \log\E_t\left[\exp\left(\underbrace{\log(\theta) - \log(\exp(s_{1, t}) - \exp(mc_t)\exp(y_t))}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{\epsilon \pi_{t + 1} + s_{1, t + 1}}_{\text{forward-looking}}\right)\right]
\end{align*}
and equation (\ref{eq:denominator recursion eqm}) becomes
\begin{align*}
  0 & = \log\E_t\left[\exp\left(\underbrace{\log(\theta) - \log(\exp(s_{2, t}) - \exp(y_t))}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{(\epsilon - 1) \pi_{t + 1} + s_{2, t + 1}}_{\text{forward-looking}}\right)\right].
\end{align*}

Equation (\ref{eq:inflation from optimal reset price eqm}) becomes
\begin{align*}
  1 & = \frac{\Pi_t^{1 - \epsilon}}{(1 - \theta)(P_t^*\Pi_t)^{1 - \epsilon} + \theta}\\
  0 & = \log\E_t\left[\exp\left((1 - \epsilon)\pi_t - \log((1 - \theta) \exp((1 - \epsilon)(p_t^* + \pi_t)) + \theta)\right)\right].
\end{align*}

Equation (\ref{eq:price dispersion evol eqm}) becomes
\begin{align*}
  1 & = \frac{V_t^p}{\Pi_t^\epsilon((1 - \theta) (P_t^*\Pi_t)^{-\epsilon} + \theta V_{t - 1}^p)}\\
  0 & = \log\E_t\left[\exp\left(v_t - \epsilon \pi_t - \log((1 - \theta) \exp(-\epsilon(p_t^* + \pi_t)) + \theta \exp(v_{t - 1}))\right)\right].
\end{align*}

Equation (\ref{eq:taylor rule eqm}) becomes
\begin{align*}
  0 & = \log\E_t\left[\exp\left(\phi_r r_{t - 1} + (1 - \phi_r)r + (1 - \phi_r)(\phi_\pi(\pi_t - \pi) + \phi_y(y_t - y_{t - 1})) + \eta_{r, t} - r_t\right)\right].
\end{align*}

Equation (\ref{eq:output market clearing eqm}) becomes
\begin{align*}
  0 & = \log\E_t\left[\exp(y_t - \log(\exp(c_t) + \exp(x_t)))\right].
\end{align*}

Equation (\ref{eq:aggregate supply eqm}) becomes
\begin{align*}
  0 & = \log\E_t\left[\exp(a_t + \alpha k_{t - 1} + (1 - \alpha)l_t - v_t - y_t)\right].
\end{align*}

Equation (\ref{eq:law of motion capital eqm}) becomes
\begin{align*}
  k_t & = \log\left(1 + \frac{\overline{X}^{1 / \chi}}{1 - 1 / \chi}(\exp(x_t - k_{t - 1}))^{1 - 1 / \chi} - \frac{\overline{X}}{1 - 1 / \chi} \right) + k_{t - 1}.
\end{align*}

The autoregressive processes (\ref{eq:ar1 beta}) to (\ref{eq:ar1 R}) remain as they are.\\

The jump variables are $y_t$, $c_t$, $l_t$, $w_t$, $r_t$, $\pi_t$, $q_t$, $x_t$, $r_{k, t}$, $\omega_t$, $mc_t$, $s_{1, t}$, $s_{2, t}$, and $v_t$.
The state variables are $k_{t - 1}$, $v_{t - 1}$, $r_{t - 1}$, $y_{t - 1}$, and the autoregressive processes. The equations defining the evolution of the lags $v_{t - 1}$, $r_{t - 1}$, and $y_{t - 1}$ are obtained by the formula $z_{(t - 1) + 1} = z_t$.


This system has three forward difference equations (\ref{eq:capital asset pricing eqm}), (\ref{eq:numerator recursion eqm}), and
(\ref{eq:denominator recursion eqm}). To ensure accuracy of the risk-adjusted linearization, I derive $N$-period
ahead forward difference equations for all three.\\

First, redefine $\Omega_t$ as
\begin{align*}
  \Omega_t = 1 - \delta + \Phi\left(\frac{X_t}{K_{t - 1}}\right) - \Phi'\left(\frac{X_t}{K_{t - 1}}\right) \frac{X_t}{K_{t - 1}}.
\end{align*}
Then we can write (\ref{eq:capital asset pricing eqm}) recursively as
\begin{align*}
  Q_t & = \E_t[M_{t, t + 1} (R_{K, t + 1} + Q_{t + 1}\Omega_{t + 1})]\\
      & = \E_t[M_{t, t + 1}R_{K, t + 1} + \Omega_{t + 1}M_{t, t + 1}\E_{t + 1}[M_{t, t + 2}(R_{K, t + 2} + Q_{t  + 2}\Omega_{t + 1})]]\\
      & = \E_t[M_{t, t + 1}R_{K, t + 1}] + \Omega_{t + 1}\E_t\E_{t + 1}[M_{t, t + 1}M_{t, t + 2}(R_{K, t + 2} + Q_{t  + 2}\Omega_{t + 2})].
\end{align*}
By the tower property,
\begin{align*}
  Q_t & = \E_t[M_{t, t + 1}R_{K, t + 1}] + \Omega_{t + 1}\E_t[M_{t, t + 1}M_{t, t + 2}(R_{K, t + 2} + Q_{t  + 2}\Omega_{t + 2})]\\
      & = \E_t\left[\left(\sum_{s = 1}^2 \left(\prod_{u = 1}^{s - 1} \Omega_{t + u}\right) \left(\prod_{u = 1}^sM_{t, t + u}\right)R_{K, t + s}\right) + M_{t, t + 1}M_{t, t + 2}Q_{t + 2}\Omega_{t + 1}\Omega_{t + 2}\right]\\
      & = \E_t\left[\left(\sum_{s = 1}^2 \left(\prod_{u = 1}^{s - 1} \Omega_{t + u}\right)\left(\prod_{u = 1}^sM_{t, t + u}\right)R_{K, t + s}\right) + \prod_{s = 1}^2 (M_{t, t + s}\Omega_{t + s})\E_{t + 2}[M_{t, t + 3}(R_{K, t + 3} + Q_{t + 3}\Omega_{t + 3})]\right]\\
      & = \E_t\left[\left(\sum_{s = 1}^3 \left(\prod_{u = 1}^{s - 1} \Omega_{t + u}\right)\left(\prod_{u = 1}^sM_{t, t + u}\right) R_{K, t + s}\right) + \prod_{s = 1}^3(M_{t, t + s}\Omega_{t + s})Q_{t + 3}\right]
\end{align*}
and so on, with the abuse of notation that $\prod_{u = 1}^0 \Omega_{t + u} = 1$. Given this recursive structure, define $D_{Q, t}^{(n)}$ and $P_{Q, t}^{(n)}$ as
\begin{align*}
  D_{Q, t}^{(n)} & = \E_t\left[\Omega_{t + 1}M_{t, t + 1}D_{Q, t + 1}^{(n - 1)}\right]\\
  P_{Q, t}^{(n)} & = \E_t\left[\Omega_{t + 1}M_{t, t + 1} P_{Q, t + 1}^{(n - 1)}\right]
\end{align*}
with boundary conditions
\begin{align*}
  D_{Q, t}^{(0)} & = \frac{R_{K, t}}{\Omega_t}\\
  P_{Q, t}^{(0)} & = Q_.
\end{align*}
Then I may write the $N$-period ahead recursive form of equation (\ref{eq:capital asset pricing eqm}) as
\begin{align*}
  Q_t & = \sum_{n = 1}^ND_{Q, t}^{(n)} + P_{Q, t}^{(N)}.
\end{align*}
To see why this recursion works, it is simpler to first verify that $P_{Q, t}^{(3)}$ is correct:
\begin{align*}
  P_{Q, t}^{(1)} & = \E_t\left[\Omega_{t + 1}M_{t, t + 1} Q_{t + 1}\right]\\
  P_{Q, t}^{(2)} & = \E_t\left[\Omega_{t + 1}M_{t, t + 1} (\E_{t + 1}[\Omega_{t + 2}M_{t, t + 2} Q_{t + 2}])\right]\\
                 & = \E_t\left[\E_{t + 1}\left[\prod_{s = 1}^2(\Omega_{t + s}M_{t, t + s}) Q_{t + 2}\right]\right]\\
                 & = \E_t\left[\prod_{s = 1}^2(\Omega_{t + s}M_{t, t + s}) Q_{t + 2}\right].
\end{align*}
where the second equality for $P_{Q, t}^{(2)}$ follows from the fact that $M_{t, t + 1}$ is measurable with respect to the information set at time $t + 1$ and can
therefore be moved insided the conditional expectation $\E_{t + 1}[\cdot]$. Continuing for one more recursion, I have
\begin{align*}
  P_{Q, t}^{(3)} & = \E_t\left[\Omega_{t + 1}M_{t, t + 1}\E_{t + 1}\left[\prod_{s = 1}^2(\Omega_{t + 1 + s}M_{t, t + 1 + s}) Q_{t + 3}\right]\right]\\
                 & = \E_t\left[\prod_{s = 1}^3(\Omega_{t + s}M_{t, t + s}) Q_{t + 3}\right].
\end{align*}
Similarly, for $D_{Q, t}$, I have
\begin{align*}
  D_{Q, t}^{(1)} & = \E_t\left[\Omega_{t + 1}M_{t, t + 1}\frac{R_{K, t + 1}}{\Omega_{t + 1}}\right] = \E_t[M_{t, t + 1} R_{K, t + 1}]\\
  D_{Q, t}^{(2)} & = \E_t[\Omega_{t + 1}M_{t, t + 1}\E_{t + 1}[M_{t, t + 2}R_{K, t + 2}]]\\
                 & = \E_t[\Omega_{t + 1}M_{t, t + 1}M_{t, t + 2}R_{K, t + 2}]\\
  D_{Q, t}^{(3)} & = \E_t[\Omega_{t + 1}M_{t, t + 1}\E_{t + 1}[\Omega_{t + 2}M_{t, t + 2}M_{t, t + 3}R_{K, t + 3}]]\\
                 & = \E_t[\Omega_{t + 1}\Omega_{t + 2}M_{t, t + 1}M_{t, t + 2}M_{t, t + 3}R_{K, t + 3}].
\end{align*}
Since $P_{Q, t}^{(n)}$ and $D_{Q, t}^{(n)}$ are time-$t$ conditional expectations, they are measurable at time $t$, so they are not forward-looking variables. Thus, to get this version of (\ref{eq:capital asset pricing eqm}) in the appropriate form, define $d_{q, n, t} = \log(D_{Q, t}^{(n)})$ and $p_{q, n, t} = \log(P_{Q, t}^{(n)})$, and use the following $2N + 1$ equations:
\begin{align}
  0 & = \log\E_t\left[\exp\left(\underbrace{q_t - \log\left(\sum_{n = 1}^{N}\exp(d_{q, n, t}) + \exp(p_{q, N, t})\right)}_{\xi}\right)\right]\\
  0 & =
      \begin{cases}
        \log\E_t\left[\exp\left(\underbrace{-d_{q, n, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{\omega_{t + 1} + d_{q, n - 1, t + 1}}_{\text{forward-looking}}\right)\right] & \text{if } n > 1\\
        \log\E_t\left[\exp\left(\underbrace{- d_{q, 1, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{r_{k, t + 1}}_{\text{forward-looking}} \right)\right] & \text{if } n = 1,
      \end{cases}\\
  0 & =
      \begin{cases}
        \log\E_t\left[\exp\left(\underbrace{-p_{q, n, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{\omega_{t + 1} + p_{q, n - 1, t + 1}}_{\text{forward-looking}} \right)\right] & \text{if } n > 1\\
        \log\E_t\left[\exp\left(\underbrace{-p_{q, 1, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{\omega_{t + 1} + q_{t + 1}}_{\text{forward-looking}}\right)\right] & \text{if }n = 1.
      \end{cases}
\end{align}


For (\ref{eq:numerator recursion eqm}), observe that
\begin{align*}
  S_{1, t} & = MC_t Y_t + \theta\E_t[M_{t, t + 1}\Pi_{t + 1}^\epsilon (MC_{t + 1}Y_{t + 1} + \theta \E_{t + 1}[M_{ t + 2}\Pi_{t + 2}^\epsilon \tilde{S}_{1, t + 2}])]\\
                   & = MC_t Y_t + \theta\E_t[M_{t, t + 1}\Pi_{t + 1}^\epsilon MC_{t + 1}Y_{t + 1} + \theta M_{t, t + 1}\Pi_{t + 1}^\epsilon M_{ t + 2}\Pi_{t + 2}^\epsilon \tilde{S}_{1, t + 2}]\\
                   & =  MC_tY_t+ \E_t\left[\sum_{s = 1}^1 (\theta^s \prod_{u = 1}^s (M_{t, t + u}\Pi_{t + u}^\epsilon)) MC_{t + s}Y_{t + s}\right] + \E_t\left[\prod_{s = 1}^2(\theta M_{t, t + s} \Pi_{t + s}^\epsilon) \tilde{S}_{1, t + 2}\right].
\end{align*}
Thus, define $D_{S1, t}^{(n)}$ and $P_{S1, t}^{(n)}$ as the recursions
\begin{align*}
  D_{S1, t}^{(n)} & = \E_t[\theta M_{t, t + 1} \Pi_{t + 1}^\epsilon D_{S1, t + 1}^{(n - 1)}],\\
  P_{S1, t}^{(n)} & = \E_t[\theta M_{t, t + 1} \Pi_{t + 1}^\epsilon P_{S1, t + 1}^{(n - 1)}],
\end{align*}
with boundary conditions
\begin{align*}
  D_{S1, t}^{(0)} & = MC_t Y_t\\
  P_{S1, t}^{(0)} & = S_{1, t}.
\end{align*}
Given these definitions, it follows that
\begin{align*}
  D_{S1, t}^{(1)} & = \E_t[\theta M_{t, t + 1} \Pi_{t + 1}^\epsilon MC_{t + 1}Y_{t + 1}]\\
  P_{S1, t}^{(1)} & = \E_t[\theta M_{t, t + 1}\Pi_{t + 1}^\epsilon \tilde{S}_{1, t + 1}]\\
  P_{S1, t}^{(2)} & = \E_t[\theta M_{t, t + 1}\Pi_{t + 1}^\epsilon\E_{t + 1}[\theta M_{t, t + 2}\Pi_{t + 2}^\epsilon \tilde{S}_{1, t + 2}]]\\
                  & = \E_t[\theta^2 M_{t, t + 1}\Pi_{t + 1}^\epsilon M_{t, t + 2}\Pi_{t + 2}^\epsilon \tilde{S}_{1, t + 2}].
\end{align*}
Thus, defining $d_{s1, t} = \log(D_{S1, t})$ and $p_{s1, t} = \log(P_{S1, t})$,
the $N$-period ahead recursive form of (\ref{eq:numerator recursion eqm}) results in the $2N + 1$ equations
\begin{align}
  0 & = \log\E_t\left[\exp\left(\underbrace{s_{1, t} - \log\left(\sum_{n = 0}^{N - 1}\exp(d_{s1, n, t}) + \exp(p_{s1, N, t})\right)}_{\xi}\right)\right]\\
  0 & =
      \begin{cases}
        \log\E_t\left[\exp\left(\underbrace{\log(\theta) - d_{s1, n, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{\epsilon \pi_{t + 1} + d_{s1, n - 1, t + 1}}_{\text{forward-looking}}\right)\right] & \text{if } n \geq 1\\
        \log\E_t\left[\exp\left(\underbrace{d_{s1, 0, t} - mc_t - y_t}_{\xi}\right)\right] & \text{if } n = 0.
      \end{cases}\\
  0 & =
      \begin{cases}
        \log\E_t\left[\exp\left(\underbrace{\log(\theta) - p_{s1, n, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{\epsilon \pi_{t + 1} + p_{s1, n - 1, t + 1}}_{\text{forward-looking}} \right)\right] & \text{if } n > 1\\
        \log\E_t\left[\exp\left(\underbrace{\log(\theta) - p_{s1, 1, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{\epsilon \pi_{t + 1} + s_{1, t + 1}}_{\text{forward-looking}}\right)\right] & \text{if } n = 1.
      \end{cases}
\end{align}
\\

It is straightforward to show that a similar recursive form applies to (\ref{eq:denominator recursion eqm}):
\begin{align}
  0 & = \log\E_t\left[\exp\left(\underbrace{s_{2, t} - \log\left(\sum_{n = 0}^{N - 1}\exp(d_{s2, n, t}) + \exp(p_{s2, N, t})\right)}_{\xi}\right)\right]\\
  0 & =
      \begin{cases}
        \log\E_t\left[\exp\left(\underbrace{\log(\theta) - d_{s2, n, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{(\epsilon - 1) \pi_{t + 1} + d_{s2, n - 1, t + 1}}_{\text{forward-looking}}\right)\right] & \text{if } n \geq 1\\
        \log\E_t\left[\exp\left(\underbrace{d_{s2, 0, t} - y_t}_{\xi}\right)\right] & \text{if } n = 0.
      \end{cases}\\
  0 & =
      \begin{cases}
        \log\E_t\left[\exp\left(\underbrace{\log(\theta) - p_{s2, n, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{(\epsilon - 1) \pi_{t + 1} + p_{s2, n - 1, t + 1}}_{\text{forward-looking}} \right)\right] & \text{if } n > 1\\
        \log\E_t\left[\exp\left(\underbrace{\log(\theta) - p_{s2, 1, t}}_{\xi} + \underbrace{m_{t + 1}}_{\text{both}} + \underbrace{(\epsilon - 1)\pi_{t + 1} + s_{2, t + 1}}_{\text{forward-looking}}\right)\right] & \text{if } n = 1,
      \end{cases}
\end{align}
where terms and boundary conditions are analogously defined.



\end{document}